<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Jean-Baptiste Féret, Florian de Boissieu" />

<meta name="date" content="2019-07-02" />

<title>Tutorial for DiversityMappR</title>






<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Tutorial for DiversityMappR</h1>
<h4 class="author">Jean-Baptiste Féret, Florian de Boissieu</h4>
<h4 class="date">2019-07-02</h4>



<p>This tutorial aims at describing the processing workflow and giving the associated code to compute <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> diversity maps on an extraction of Sentinel-2 image taken over Cameroun forest. The workflow is composed of the following steps:</p>
<ul>
<li><p>define the processing parameters</p>
<ul>
<li>input / output files paths</li>
<li>output spatial resolution</li>
<li>computing options</li>
</ul></li>
<li>compute the <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> diversity maps:
<ul>
<li>compute PCA and select best components</li>
<li>compute the diversity maps</li>
</ul></li>
<li><p>validate results comparing to field plots measurements</p></li>
</ul>
<div id="processing-parameters" class="section level1">
<h1><span class="header-section-number">1</span> Processing parameters</h1>
<div id="input-output-files" class="section level2">
<h2><span class="header-section-number">1.1</span> Input / Output files</h2>
<p>The input images are expected to be in ENVI HDR format, BIL interleaved. To check if the flormat is good use fucntion <code>Check.Data.Format</code>. If not they should be converted with function <code>Convert.Raster2BIL</code>.</p>
<p>A mask can also be set to work on a selected part of the input image. The mask is expected to be a raster in the same format as the image (ENVI HDR), with values 0 = masked or 1 = selected. If no mask is to be used set <code>Input.Mask.File = FALSE</code>.</p>
<pre><code>Input.Image.File  = system.file('extdata', 'RASTER', 'S2A_T33NUD_20180104_Subset', package = 'DiversityMappR')
Check.Data.Format(Input.Image.File)

Input.Image.File  = Convert.Raster2BIL(Raster.Path = Input.Image.File,
                                       Sensor = 'SENTINEL_2A',
                                       Convert.Integer = TRUE,
                                       Output.Directory = '~/test')
Input.Mask.File   = FALSE</code></pre>
<p>The output directory defined with <code>Output.Dir</code> will contain all the results. For each image processed, a subdirectory will be automatically created after its name.</p>
<pre><code>Output.Dir        = 'RESULTS'</code></pre>
</div>
<div id="spatial-resolution" class="section level2">
<h2><span class="header-section-number">1.2</span> Spatial resolution</h2>
<p>The algorithm estimates and diversity within a window, that is also the output spatial resolution. It is defined in number of pixel s of the input image with parameter <code>Spatial.Res</code>, e.g. <code>Spatial.Res = 10</code> meaning a window of 10x10 pixels. It will be the spatial resolution of the ouput rasters.</p>
<p>As a rule of thumb, spatial units between 0.25 and 4 ha usually match with ground data. A Spatial.Res too small results in low number of pixels per spatial unit, hence limited range of variation of diversity in the image.</p>
<p>In this example, the spatial resolution of the input raster. Setting <code>Spatial.Res = 10</code> will result in diversity maps of spatial resolution 100x100m.</p>
<pre><code>Spatial.Res = 10</code></pre>
</div>
<div id="pca-filtering" class="section level2">
<h2><span class="header-section-number">1.3</span> PCA filtering</h2>
<p>If set to <code>TRUE</code>, a second filtering based on PCA outliers is processed.</p>
<pre><code>FilterPCA = TRUE</code></pre>
</div>
<div id="computing-options" class="section level2">
<h2><span class="header-section-number">1.4</span> Computing options</h2>
<p>The use of computing ressources can be controled with the following parameters:</p>
<ul>
<li><code>nbCPU</code> controls the parallelisation of the processing,</li>
<li><code>MaxRAM</code> controls the size in GB of the input image chunks processed by each thread,</li>
<li><code>nbclusters</code> controls the number of clusters (or centroids) used in kmeans of each thread. The larger is <code>nbclusters</code> the longer the computation time.</li>
</ul>
<pre><code>nbCPU         = 4
MaxRAM        = 0.5
nbclusters    = 50</code></pre>
</div>
</div>
<div id="main-processing-worflow" class="section level1">
<h1><span class="header-section-number">2</span> Main processing worflow</h1>
<div id="mask-non-vegetated-shaded-cloudy-pixels" class="section level2">
<h2><span class="header-section-number">2.1</span> Mask non vegetated / shaded / cloudy pixels</h2>
<pre><code>NDVI.Thresh = 0.5
Blue.Thresh = 500
NIR.Thresh  = 1500
print(&quot;PERFORM RADIOMETRIC FILTERING&quot;)
ImPathShade = Perform.Radiometric.Filtering(Input.Image.File, Input.Mask.File, Output.Dir,
                                            NDVI.Thresh = NDVI.Thresh, Blue.Thresh = Blue.Thresh,
                                            NIR.Thresh = NIR.Thresh)</code></pre>
</div>
<div id="pca" class="section level2">
<h2><span class="header-section-number">2.2</span> PCA</h2>
<p>A pixel-based PCA is run on the input image across the spectral bands to select the most interesting spectral information relative to spectral diversity and remove shaded pixels, spatial noise and sensor artefacts. This PCA band selection left to user judgement, wrinting to a file the bands to keep. The file is automatically created and ready to edit with function <code>Select.Components</code>. One band number by line is expected in this file. For this example PCA bands 1, 2 and 5 should be kept writting the following in file <code>selected_components.txt</code> open for edition:</p>
<pre><code>1
2
5</code></pre>
<p>Here is the code to perform PCA and select PCA bands:</p>
<pre><code>print(&quot;PERFORM PCA ON RASTER&quot;)
PCA.Files  = Perform.PCA.Image(Input.Image.File, ImPathShade, Output.Dir,
                               FilterPCA = TRUE, nbCPU = nbCPU, MaxRAM = MaxRAM)
print(&quot;Select PCA components for diversity estimations&quot;)
Select.Components(Input.Image.File, Output.Dir, PCA.Files, File.Open = TRUE)</code></pre>
</div>
<div id="alpha-and-beta-diversity-maps" class="section level2">
<h2><span class="header-section-number">2.3</span> <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> diversity maps</h2>
<pre><code>print(&quot;MAP SPECTRAL SPECIES&quot;)
Map.Spectral.Species(Input.Image.File, Output.Dir, PCA.Files,
                     nbCPU = nbCPU, MaxRAM = MaxRAM)

print(&quot;MAP ALPHA DIVERSITY&quot;)
# Index.Alpha   = c('Shannon','Simpson')
Index.Alpha   = c('Shannon')
Map.Alpha.Diversity(Input.Image.File, Output.Dir, Spatial.Res,
                    nbCPU = nbCPU, MaxRAM = MaxRAM, Index.Alpha = Index.Alpha)

print(&quot;MAP BETA DIVERSITY&quot;)
Map.Beta.Diversity(Input.Image.File, Output.Dir, Spatial.Res,
                   nbCPU = nbCPU, MaxRAM = MaxRAM)</code></pre>
</div>
</div>
<div id="validation" class="section level1">
<h1><span class="header-section-number">3</span> Validation</h1>
<p>The folowing code computes <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> diversity from field plots and extracts the corresponding diversity index from previouly computed rasters in order to have a validation analysis.</p>
<pre><code># location of the spectral species raster needed for validation
TypePCA     = 'SPCA'
Dir.Raster  = file.path(Output.Dir,basename(Input.Image.File),TypePCA,'SpectralSpecies')
Name.Raster = 'SpectralSpecies'
Path.Raster = file.path(Dir.Raster,Name.Raster)

# location of the directory where shapefiles used for validation are saved
vect        = system.file('extdata', 'VECTOR', package = 'DiversityMappR')
Shannon.All = list() # ??

# list vector data
Path.Vector         = Get.List.Shp(vect)
Name.Vector         = tools::file_path_sans_ext(basename(Path.Vector))

# read raster data including projection
RasterStack         = stack(Path.Raster)
Projection.Raster   = Get.Projection(Path.Raster,'raster')

# get alpha and beta diversity indicators corresponding to shapefiles
Biodiv.Indicators           = Get.Diversity.From.Plots(Raster = Path.Raster, Plots = Path.Vector,NbClusters = nbclusters)
# if no name
Biodiv.Indicators$Name.Plot = seq(1,length(Biodiv.Indicators$Shannon[[1]]),by = 1)
Shannon.RS                  = c(Biodiv.Indicators$Shannon)[[1]]</code></pre>
<p>The tables are then written to tab-seperated files.</p>
<pre><code># write RS indicators
####################################################
# write indicators for alpha diversity
Path.Results = file.path(Output.Dir, basename(Input.Image.File), TypePCA, 'VALIDATION')
dir.create(Path.Results, showWarnings = FALSE, recursive = TRUE)
ShannonIndexFile &lt;- file.path(Path.Results, &quot;ShannonIndex.tab&quot;)
write.table(Shannon.RS, file = ShannonIndexFile, sep = &quot;\t&quot;, dec = &quot;.&quot;, na = &quot; &quot;, 
            row.names = Biodiv.Indicators$Name.Plot, col.names= F, quote=FALSE)

Results =  data.frame(Name.Vector, Biodiv.Indicators$Richness, Biodiv.Indicators$Fisher,                                Biodiv.Indicators$Shannon, Biodiv.Indicators$Simpson)
names(Results)  = c(&quot;ID_Plot&quot;, &quot;Species_Richness&quot;, &quot;Fisher&quot;, &quot;Shannon&quot;, &quot;Simpson&quot;)
write.table(Results, file = paste(Path.Results,&quot;AlphaDiversity.tab&quot;,sep=''), sep=&quot;\t&quot;, dec=&quot;.&quot;,               na=&quot; &quot;, row.names = F, col.names= T,quote=FALSE)

# write indicators for beta diversity
BC_mean = Biodiv.Indicators$BCdiss
colnames(BC_mean) = rownames(BC_mean) = Biodiv.Indicators$Name.Plot
write.table(BC_mean, file = paste(Path.Results,&quot;BrayCurtis.csv&quot;,sep=''), sep=&quot;\t&quot;, dec=&quot;.&quot;, na=&quot; &quot;, row.names = F, col.names= T,quote=FALSE)
</code></pre>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
